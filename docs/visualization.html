<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.9.1" />
<title>data_utils.visualization API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>data_utils.visualization</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">import colorlover as cl                                 # Get colors from colorscales
import plotly.graph_objs as go                          # Plotly for interactive and pretty plots
import dash_core_components as dcc                      # Dash components to be used in a dashboard
import dash_bootstrap_components as dbc                 # Dash bootstrap components
import numpy as np                                      # NumPy to handle numeric and NaN operations
import data_utils as du

# Pandas to handle the data in dataframes
if du.use_modin is True:
    import modin.pandas as pd
else:
    import pandas as pd

# Colors to use in performance or quality plots
perf_colors = cl.scales[&#39;8&#39;][&#39;div&#39;][&#39;RdYlGn&#39;]

# Methods

def set_bar_color(values, ids, seq_len, threshold=0,
                  neg_color=&#39;rgba(30,136,229,1)&#39;, pos_color=&#39;rgba(255,13,87,1)&#39;):
    &#39;&#39;&#39;Determine each bar&#39;s color in a bar chart, according to the values being
    plotted and the predefined threshold.

    Parameters
    ----------
    values : numpy.Array
        Array containing the values to be plotted.
    ids : int or list of ints
        ID or list of ID&#39;s that select which time series / sequences to use in
        the color selection.
    seq_len : int or list of ints
        Single or multiple sequence lengths, which represent the true, unpadded
        size of the input sequences.
    threshold : int or float, default 0
        Value to use as a threshold in the plot&#39;s color selection. In other
        words, values that exceed this threshold will have one color while the
        remaining have a different one, as specified in the parameters.
    pos_color : string
        Color to use in the bars corresponding to threshold exceeding values.
    neg_color : string
        Color to use in the bars corresponding to values bellow the threshold.

    Returns
    -------
    colors : list of strings
        Resulting bar colors list.
    &#39;&#39;&#39;
    if type(ids) is list:
        # Create a list of lists, with the colors for each sequences&#39; instances
        return [[pos_color if val &gt; 0 else neg_color for val in values[id, :seq_len]]
                for id in ids]
    else:
        # Create a single list, with the colors for the sequence&#39;s instances
        return [pos_color if val &gt; 0 else neg_color for val in values[ids, :seq_len]]


def indicator_plot(value, min_val=0, max_val=100, type=&#39;bullet&#39;, higher_is_better=True,
                   background_color=&#39;white&#39;, output_type=&#39;plotly&#39;, dash_id=&#39;some_indicator&#39;,
                   dash_height=None, dash_width=None, show_number=True, show_graph=True, 
                   show_delta=False, ref_value=None, font_family=&#39;Roboto&#39;, font_size=14, 
                   font_color=&#39;black&#39;, prefix=&#39;&#39;, suffix=&#39;&#39;, showticklabels=False, 
                   animate=False, margin_left=0, margin_right=0, margin_top=0, 
                   margin_bottom=0, padding=0):
    &#39;&#39;&#39;Generate an indicator plot, which can help visualize performance. Can
    either be of type bullet or gauge.

    Parameters
    ----------
    value : int
        Value which will be plotted on the graph.
    type : str, default &#39;bullet&#39;
        Type of indicator plot. Can either be &#39;bullet&#39; or &#39;gauge&#39;.
    min_val : int, default 0
        Minimum value in the range of numbers that the input can assume.
    max_val : int, default 100
        Maximum value in the range of numbers that the input can assume.
    higher_is_better : bool, default True
        If set to True, values closer to the maximum will be represented in green,
        while those closer to the minimum will be in red. Vice versa for False.
    background_color : str, default &#39;white&#39;
        The plot&#39;s background color. Can be set in color name (e.g. &#39;white&#39;),
        hexadecimal code (e.g. &#39;#555&#39;) or RGB (e.g. &#39;rgb(0,0,255)&#39;).
    output_type : str, default &#39;plotly&#39;
        The format on which the output is presented. Available options are
        &#39;dash&#39;, `plotly` and &#39;figure&#39;.
    dash_id : str, default &#39;some_indicator&#39;
        ID to be used in Dash.
    dash_height : str, default None
        Height value to be used in the Dash graph.
    dash_width : str, default None
        Width value to be used in the Dash graph.
    show_number : bool, default True
        If set to True, the number will be shown, whether next to the plot or
        on its own.
    show_graph : bool, default True
        If set to True, the graph, whether bullet or gauge, will be displayed.
    show_delta : bool, default False
        If set to True, the value&#39;s variation, based on a reference value, will
        be plotted.
    ref_value : int or float, default None
        Reference value to use in the delta visualization.
    font_family : str, default &#39;Roboto&#39;
        Text font family to be used in the numbers shown next to the graph.
    font_size : int, default 14
        Text font size to be used in the numbers shown next to the graph.
    font_color : str, default &#39;black&#39;
        Text font color to be used in the numbers shown next to the graph. Can
        be set in color name (e.g. &#39;white&#39;), hexadecimal code (e.g. &#39;#555&#39;) or
        GB (e.g. &#39;rgb(0,0,255)&#39;).
    prefix : str, default &#39;&#39;
        Text to be appended to the beginning of the number, shown next to the
        indicator graph. e.g. &#39;%&#39;, &#39;€&#39;, &#39;km&#39;, &#39;g&#39;
    suffix : str, default &#39;&#39;
        Text to be appended to the end of the number, shown next to the
        indicator graph. e.g. &#39;%&#39;, &#39;€&#39;, &#39;km&#39;, &#39;g&#39;
    showticklabels : bool, default False
        Determines whether or not the tick labels are drawn.
    animate : bool, default False
        If true, animate between updates using plotly.js&#39;s `animate` function.
    margin_left : int, default 0
        Sets the left margin (in px).
    margin_right : int, default 0
        Sets the right margin (in px).
    margin_top : int, default 0
        Sets the top margin (in px).
    margin_bottom : int, default 0
        Sets the bottom margin (in px).
    padding : int, default 0
        Sets the amount of padding (in px) between the plotting area and 
        the axis lines.

    Returns
    -------
    If output_type == &#39;figure&#39;:

    figure : dict
        Figure dictionary which can be used in Plotly.

    Else if output_type == &#39;plotly&#39;:

    figure : plotly.graph_objs._figure.Figure
        Figure in a plotly figure object, which can be displayed in a notebook.

    Else if output_type == &#39;dash&#39;:

    figure : dcc.Graph
        Figure in a Dash graph format, ready to be used in a dashboard.
    &#39;&#39;&#39;
    global perf_colors
    if show_graph:
        # Define the bar color
        if higher_is_better:
            color = perf_colors[int(max((value/max_val)*len(perf_colors)-1, 0))]
        else:
            color = perf_colors[len(perf_colors)-1-int(max((value/max_val)*len(perf_colors)-1, 0))]
    # Define if the value and the delta is shown next to the plot
    if show_number and show_graph and show_delta:
        mode = &#39;number+gauge+delta&#39;
    elif show_number and show_graph and not show_delta:
        mode = &#39;number+gauge&#39;
    elif show_number and not show_graph and show_delta:
        mode = &#39;number+delta&#39;
    elif show_number and not show_graph and not show_delta:
        mode = &#39;number&#39;
    elif not show_number and show_graph and show_delta:
        mode = &#39;gauge+delta&#39;
    elif not show_number and show_graph and not show_delta:
        mode = &#39;gauge&#39;
    if type.lower() == &#39;bullet&#39;:
        shape = &#39;bullet&#39;
    elif type.lower() == &#39;gauge&#39;:
        shape = &#39;angular&#39;
    else:
        raise Exception(f&#39;ERROR: Invalid indicator plot type inserted. Expected &#34;bullet&#34; or &#34;gauge&#34;, received &#34;{type}&#34;.&#39;)
    # Create the figure
    figure=dict(
        data=[dict(
            type=&#39;indicator&#39;,
            mode=mode,
            value=value,
            number=dict(
                font=dict(
                    family=font_family,
                    size=font_size,
                    color=font_color
                ),
                prefix=prefix,
                suffix=suffix
            ),
            delta=dict(reference=ref_value)
        )],
        layout=dict(
            paper_bgcolor=background_color,
            margin=dict(l=margin_left, r=margin_right, t=margin_top, b=margin_bottom, pad=padding),
            font=dict(
                family=font_family,
                size=font_size,
                color=font_color
            )
        )
    )
    if show_graph:
        # Add the graph
        figure[&#39;data&#39;][0][&#39;gauge&#39;] = dict(
            shape=shape,
            bar=dict(
                thickness=1,
                color=color
            ),
            axis=dict(
                range=[min_val, max_val],
                showticklabels=showticklabels
            )
        )
    if output_type == &#39;figure&#39;:
        return figure
    elif output_type == &#39;plotly&#39;:
        return go.Figure(figure)
    elif output_type == &#39;dash&#39;:
        style = dict()
        if dash_height is not None:
            style[&#39;height&#39;] = dash_height
        if dash_width is not None:
            style[&#39;width&#39;] = dash_width
        return dcc.Graph(
            id=dash_id,
            figure=figure,
            style=style,
            config=dict(displayModeBar=False),
            animate=animate
        )
    else:
        raise Exception(f&#39;ERROR: Invalid output type {output_type}. Only `figure`, `plotly` and `dash` are currently supported.&#39;)


def shap_summary_plot(shap_values, feature_names, max_display=10,
                      background_color=&#39;white&#39;, marker_color=&#39;blue&#39;,
                      output_type=&#39;plotly&#39;, dash_id=&#39;some_shap_summary_plot&#39;,
                      dash_height=None, dash_width=None, font_family=&#39;Roboto&#39;,
                      font_size=14, font_color=&#39;black&#39;,
                      xaxis_title=&#39;mean(|SHAP value|) (average impact on model output magnitude)&#39;,
                      margin_left=0, margin_right=0, margin_top=0, margin_bottom=0, padding=0):
    &#39;&#39;&#39;Plot the overall feature importance, based on SHAP values, through an
    horizontal bar plot.

    Parameters
    ----------
    shap_values : numpy.ndarray or list
        Array or list containing all the SHAP values which we want to plot.
    feature_names : list
        List with the names of the features that the SHAP values refer to.
    max_display : int
        The maximum number of features to plot.
    background_color : str, default &#39;white&#39;
        The plot&#39;s background color. Can be set in color name (e.g. &#39;white&#39;),
        hexadecimal code (e.g. &#39;#555&#39;) or RGB (e.g. &#39;rgb(0,0,255)&#39;).
    marker_color : str, default &#39;blue&#39;
        The color of the bars in the plot. Can be set in color name (e.g. &#39;white&#39;),
        hexadecimal code (e.g. &#39;#555&#39;) or RGB (e.g. &#39;rgb(0,0,255)&#39;).
    output_type : str, default &#39;plotly&#39;
        The format on which the output is presented. Available options are
        &#39;dash&#39;, `plotly` and &#39;figure&#39;.
    dash_id : str, default &#39;some_shap_summary_plot&#39;
        ID to be used in Dash.
    dash_height : str, default None
        Height value to be used in the Dash graph.
    dash_width : str, default None
        Width value to be used in the Dash graph.
    font_family : str, default &#39;Roboto&#39;
        Text font family to be used in the numbers shown next to the graph.
    font_size : int, default 14
        Text font size to be used in the numbers shown next to the graph.
    font_color : str, default &#39;black&#39;
        Text font color to be used in the numbers shown next to the graph. Can
        be set in color name (e.g. &#39;white&#39;), hexadecimal code (e.g. &#39;#555&#39;) or
        GB (e.g. &#39;rgb(0,0,255)&#39;).
    xaxis_title : str, default &#39;mean(|SHAP value|) (average impact on model output magnitude)&#39;
        Phrase that appears bellow the X axis.
    margin_left : int, default 0
        Sets the left margin (in px).
    margin_right : int, default 0
        Sets the right margin (in px).
    margin_top : int, default 0
        Sets the top margin (in px).
    margin_bottom : int, default 0
        Sets the bottom margin (in px).
    padding : int, default 0
        Sets the amount of padding (in px) between the plotting area and 
        the axis lines.

    Returns
    -------
    If output_type == &#39;figure&#39;:

    figure : dict
        Figure dictionary which can be used in Plotly.

    Else if output_type == &#39;plotly&#39;:

    figure : plotly.graph_objs._figure.Figure
        Figure in a plotly figure object, which can be displayed in a notebook.

    Else if output_type == &#39;dash&#39;:

    figure : dcc.Graph
        Figure in a Dash graph format, ready to be used in a dashboard.
    &#39;&#39;&#39;
    # Calculate the mean absolute value of each feature&#39;s SHAP values
    mean_abs_shap = np.mean(np.abs(shap_values).reshape(-1, shap_values.shape[-1]), axis=0)
    # Sort the SHAP values and the feature names
    sorted_idx = np.argsort(mean_abs_shap)
    if max_display is not None:
        # Only show the `max_display` most impactful features
        sorted_idx = sorted_idx[-max_display:]
    sorted_mean_abs_shap = mean_abs_shap[sorted_idx]
    sorted_feature_names = [feature_names[idx] for idx in sorted_idx]
    # Create the figure
    figure=dict(
        data=[dict(
            type=&#39;bar&#39;,
            x=sorted_mean_abs_shap,
            y=sorted_feature_names,
            orientation=&#39;h&#39;,
            marker=dict(color=marker_color)
        )],
        layout=dict(
            paper_bgcolor=background_color,
            plot_bgcolor=background_color,
            margin=dict(l=margin_left, r=margin_right, t=margin_top, b=margin_bottom, pad=padding),
            xaxis_title=xaxis_title,
            xaxis=dict(showgrid=False),
            font=dict(
                family=font_family,
                size=font_size,
                color=font_color
            )
        )
    )
    if output_type == &#39;figure&#39;:
        return figure
    elif output_type == &#39;plotly&#39;:
        return go.Figure(figure)
    elif output_type == &#39;dash&#39;:
        style = dict()
        if dash_height is not None:
            style[&#39;height&#39;] = dash_height
        if dash_width is not None:
            style[&#39;width&#39;] = dash_width
        return dcc.Graph(
            id=dash_id,
            figure=figure,
            style=style
        )
    else:
        raise Exception(f&#39;ERROR: Invalid output type {output_type}. Only `figure`, `plotly` and `dash` are currently supported.&#39;)


def shap_waterfall_plot(expected_value, shap_values, features, feature_names,
                        max_display=10, background_color=&#39;white&#39;,
                        line_color=&#39;gray&#39;, increasing_color=&#39;red&#39;,
                        decreasing_color=&#39;blue&#39;, output_type=&#39;plotly&#39;,
                        dash_id=&#39;some_shap_summary_plot&#39;, dash_height=None,
                        dash_width=None, expected_value_ind_height=0,
                        output_ind_height=10, font_family=&#39;Roboto&#39;, 
                        font_size=14, font_color=&#39;black&#39;,
                        margin_left=0, margin_right=0, margin_top=0, 
                        margin_bottom=0, padding=0):
    &#39;&#39;&#39;Do a waterfall plot on a single sample, based on SHAP values, showing
    each feature&#39;s contribution to the corresponding output.

    Parameters
    ----------
    expected_value : float
        This is the reference value that the feature contributions start from.
        For SHAP values it should be the value of explainer.expected_value.
    shap_values : numpy.array
        One dimensional array of SHAP values.
    features : numpy.array
        One dimensional array of feature values. This provides the values of all
        the features, and should be the same shape as the shap_values argument.
    feature_names : list
        List of feature names (# features).
    max_display : str
        The maximum number of features to plot.
    background_color : str, default &#39;white&#39;
        The plot&#39;s background color. Can be set in color name (e.g. &#39;white&#39;),
        hexadecimal code (e.g. &#39;#555&#39;) or RGB (e.g. &#39;rgb(0,0,255)&#39;).
    line_color : str, default &#39;gray&#39;
        The waterfall plot&#39;s connector color. Can be set in color name
        (e.g. &#39;white&#39;), hexadecimal code (e.g. &#39;#555&#39;) or RGB (e.g. &#39;rgb(0,0,255)&#39;).
    increasing_color : str, default &#39;red&#39;
        Color of the waterfall bars that indicate an increasing value.
    decreasing_color : str, default &#39;blue&#39;
        Color of the waterfall bars that indicate a decreasing value.
    output_type : str, default &#39;plotly&#39;
        The format on which the output is presented. Available options are
        &#39;dash&#39;, `plotly` and &#39;figure&#39;.
    dash_id : str, default &#39;some_shap_summary_plot&#39;
        ID to be used in Dash.
    dash_height : str, default None
        Height value to be used in the Dash graph.
    dash_width : str, default None
        Width value to be used in the Dash graph.
    expected_value_ind_height : int, default 0
        Height of the expected value indicator.
    output_ind_height : int, default 10
        Height of the output indicator.
    font_family : str, default &#39;Roboto&#39;
        Text font family to be used in the numbers shown next to the graph.
    font_size : int, default 14
        Text font size to be used in the numbers shown next to the graph.
    font_color : str, default &#39;black&#39;
        Text font color to be used in the numbers shown next to the graph. Can
        be set in color name (e.g. &#39;white&#39;), hexadecimal code (e.g. &#39;#555&#39;) or
        GB (e.g. &#39;rgb(0,0,255)&#39;).
    margin_left : int, default 0
        Sets the left margin (in px).
    margin_right : int, default 0
        Sets the right margin (in px).
    margin_top : int, default 0
        Sets the top margin (in px).
    margin_bottom : int, default 0
        Sets the bottom margin (in px).
    padding : int, default 0
        Sets the amount of padding (in px) between the plotting area and 
        the axis lines.

    Returns
    -------
    If output_type == &#39;figure&#39;:

    figure : dict
        Figure dictionary which can be used in Plotly.

    Else if output_type == &#39;plotly&#39;:

    figure : plotly.graph_objs._figure.Figure
        Figure in a plotly figure object, which can be displayed in a notebook.

    Else if output_type == &#39;dash&#39;:

    figure : dcc.Graph
        Figure in a Dash graph format, ready to be used in a dashboard.
    &#39;&#39;&#39;
    if len(shap_values.shape) &gt; 1:
        raise Exception(f&#39;ERROR: Received multiple samples, with input shape {shap_values.shape}. The waterfall plot only handles individual samples, i.e. one-dimensional inputs.&#39;)
    # Get the model&#39;s output on the current sample
    model_output = shap_values.sum() + expected_value
    # Sort the SHAP values and the feature names
    sorted_idx = np.argsort(np.abs(shap_values))
    sorted_shap_values = shap_values[sorted_idx]
    sorted_features = features[sorted_idx]
    sorted_feature_names = [feature_names[idx] for idx in sorted_idx]
    if max_display is None:
        max_display = len(sorted_feature_names)
    if max_display &lt; len(sorted_feature_names):
        # Isolate the data regarding the less relevant features that will be aggregated
        other_features_shap_values = sorted_shap_values[:-(max_display-1)]
        other_features_names = sorted_feature_names[:-(max_display-1)]
        n_other_features = len(other_features_names)
        # Get the sum of the less relevant features&#39; SHAP values
        other_features_shap_values = other_features_shap_values.sum()
        # Remove the detailed info of the less relevant features
        sorted_shap_values = sorted_shap_values[-(max_display-1):]
        sorted_feature_names = sorted_feature_names[-(max_display-1):]
        sorted_features = sorted_features[-(max_display-1):]
        # Add the less relevant features aggregate data into the plot
        hovertext = [f&#39;{feature}={val}&#39; if du.utils.is_integer(val) else f&#39;{feature}={val:.2e}&#39;
                     for (feature, val) in zip(sorted_feature_names, sorted_features)]
        hovertext = [&#39;Multiple features&#39;] + hovertext
        sorted_shap_values = np.insert(sorted_shap_values, 0, other_features_shap_values)
        sorted_feature_names = [f&#39;{n_other_features} other features&#39;] + sorted_feature_names
    else:
        hovertext = [f&#39;{feature}={val}&#39; if du.utils.is_integer(val) else f&#39;{feature}={val:.2e}&#39;
                     for (feature, val) in zip(sorted_feature_names, sorted_features)]
    # Create the figure
    figure=dict(
        data=[dict(
            type=&#39;waterfall&#39;,
            x=sorted_shap_values,
            y=sorted_feature_names,
            base=expected_value,
            hovertext=hovertext,
            orientation=&#39;h&#39;,
            connector=dict(line=dict(color=line_color)),
            increasing=dict(marker=dict(color=increasing_color)),
            decreasing=dict(marker=dict(color=decreasing_color))
        )],
        layout=dict(
            paper_bgcolor=background_color,
            plot_bgcolor=background_color,
            margin=dict(l=margin_left, r=margin_right, t=margin_top, b=margin_bottom, pad=padding),
            xaxis_title=&#39;Output value&#39;,
            xaxis=dict(showgrid=False, autorange=True, rangemode=&#39;normal&#39;),
            font=dict(
                family=font_family,
                size=font_size,
                color=font_color
            ),
            annotations=[
                # Expected value indicator
                dict(
                    # x-reference is assigned to the x-values
                    xref=&#39;x&#39;,
                    # y-reference is assigned to the plot paper [0,1]
                    yref=&#39;paper&#39;,
                    x=expected_value,
                    y=0,
                    text=f&#39;E[f(X)]={expected_value:.2e}&#39;,
                    showarrow=True,
                    arrowhead=0,
                    ax=0,
                    ay=expected_value_ind_height
                ),
                # Output value indicator
                dict(
                    # x-reference is assigned to the x-values
                    xref=&#39;x&#39;,
                    # y-reference is assigned to the plot paper [0,1]
                    yref=&#39;paper&#39;,
                    x=model_output,
                    y=1,
                    text=f&#39;f(x)={model_output:.2e}&#39;,
                    showarrow=True,
                    arrowhead=0,
                    ax=0,
                    ay=output_ind_height
                )
            ],
            shapes=[
                # Expected value line
                dict(
                    type=&#39;line&#39;,
                    # x-reference is assigned to the x-values
                    xref=&#39;x&#39;,
                    # y-reference is assigned to the plot paper [0,1]
                    yref=&#39;paper&#39;,
                    x0=expected_value,
                    y0=0,
                    x1=expected_value,
                    y1=1,
                    fillcolor=line_color,
                    line=dict(
                        color=line_color,
                        width=1
                    ),
                    opacity=0.5,
                    # NOTE: I can&#39;t put this line bellow the traces, otherwise
                    # the waterfall conectors will create a blank line in the middle of it
#                     layer=&#39;below&#39;
                ),
                # Output value line
                dict(
                    type=&#39;line&#39;,
                    # x-reference is assigned to the x-values
                    xref=&#39;x&#39;,
                    # y-reference is assigned to the plot paper [0,1]
                    yref=&#39;paper&#39;,
                    x0=model_output,
                    y0=0,
                    x1=model_output,
                    y1=1,
                    fillcolor=line_color,
                    line=dict(
                        color=line_color,
                        width=1
                    ),
                    opacity=0.5,
                    layer=&#39;below&#39;
                )
            ]
        )
    )
    if output_type == &#39;figure&#39;:
        return figure
    elif output_type == &#39;plotly&#39;:
        return go.Figure(figure)
    elif output_type == &#39;dash&#39;:
        style = dict()
        if dash_height is not None:
            style[&#39;height&#39;] = dash_height
        if dash_width is not None:
            style[&#39;width&#39;] = dash_width
        return dcc.Graph(
            id=dash_id,
            figure=figure,
            style=style
        )
    else:
        raise Exception(f&#39;ERROR: Invalid output type {output_type}. Only `figure`, `plotly` and `dash` are currently supported.&#39;)


def shap_salient_features(shap_values, features, feature_names,
                          max_display=10, background_color=&#39;white&#39;,
                          increasing_color=&#39;success&#39;,
                          decreasing_color=&#39;danger&#39;,
                          font_family=&#39;Roboto&#39;, font_size=14,
                          font_color=&#39;black&#39;,
                          dash_height=None, dash_width=None):
    &#39;&#39;&#39;Create a list of the most salient features, and their corresponding 
    maximum impact values, based on SHAP values. Only works in Dash, with
    bootstrap components.

    Parameters
    ----------
    shap_values : numpy.array
        Two dimensional array of SHAP values.
    features : numpy.array
        Two dimensional array of feature values. This provides the values of all
        the features, and should be the same shape as the shap_values argument.
    feature_names : list
        List of feature names (# features).
    max_display : str
        The maximum number of features to show.
    background_color : str, default &#39;white&#39;
        The plot&#39;s background color. Can be set in color name (e.g. &#39;white&#39;),
        hexadecimal code (e.g. &#39;#555&#39;) or RGB (e.g. &#39;rgb(0,0,255)&#39;).
    line_color : str, default &#39;gray&#39;
        The waterfall plot&#39;s connector color. Can be set in color name
        (e.g. &#39;white&#39;), hexadecimal code (e.g. &#39;#555&#39;) or RGB (e.g. &#39;rgb(0,0,255)&#39;).
    increasing_color : str, default &#39;red&#39;
        Color of the waterfall bars that indicate an increasing value.
    decreasing_color : str, default &#39;blue&#39;
        Color of the waterfall bars that indicate a decreasing value.
    output_type : str, default &#39;plotly&#39;
        The format on which the output is presented. Available options are
        &#39;dash&#39;, `plotly` and &#39;figure&#39;.
    dash_height : str, default None
        Height value to be used in the Dash graph.
    dash_width : str, default None
        Width value to be used in the Dash graph.
    font_family : str, default &#39;Roboto&#39;
        Text font family to be used in the numbers shown next to the graph.
    font_size : int, default 14
        Text font size to be used in the numbers shown next to the graph.
    font_color : str, default &#39;black&#39;
        Text font color to be used in the numbers shown next to the graph. Can
        be set in color name (e.g. &#39;white&#39;), hexadecimal code (e.g. &#39;#555&#39;) or
        GB (e.g. &#39;rgb(0,0,255)&#39;).

    Returns
    -------
    salient_feat : list of dbc.ListGroupItem
        List of the most salient features, ready to be used in a dashboard.
    &#39;&#39;&#39;
    # [TODO] Add support for a single sample (1D) or multiple sequences (3D)
    if len(shap_values.shape) != 2:
        raise Exception(f&#39;ERROR: Expected a sequence of data, i.e. a two dimensional array. Received a {shap_values.shape}D input.&#39;)
    # Create a dictionary to match each feature to its biggest absolute value,
    # the corresponding feature value (found by the data point&#39;s index)
    # and color (according to the SHAP value sign)
    saliency_dict = dict()
    # Indices of the maximum absolute SHAP value for each feature
    abs_shap = abs(shap_values)
    max_abs_shap_val_idx = np.argmax(abs_shap, axis=0)
    for feat_num in range(shap_values.shape[-1]):
        # Get the feature name, maximum absolute SHAP value and data value
        feature = feature_names[feat_num]
        saliency_dict[feature] = dict()
        saliency_dict[feature][&#39;max_abs_shap_val&#39;] = shap_values[max_abs_shap_val_idx[feat_num], feat_num]
        saliency_dict[feature][&#39;data_val&#39;] = features[max_abs_shap_val_idx[feat_num], feat_num]
        # Set the Dash list item color
        if saliency_dict[feature][&#39;max_abs_shap_val&#39;] &gt; 0:
            saliency_dict[feature][&#39;dash_color&#39;] = increasing_color 
        else:
            saliency_dict[feature][&#39;dash_color&#39;] = decreasing_color
    # Sort the features by their maximum SHAP value, in a descending order
    saliency_dict = sorted(saliency_dict.items(), key=lambda item: abs(item[1][&#39;max_abs_shap_val&#39;]))
    saliency_dict.reverse()
    saliency_dict = dict(saliency_dict)
    # Filter to the top `max_display` features
    if max_display is None or max_display &gt; len(saliency_dict):
        max_display = len(saliency_dict)
    # Create the Dash list
    count = 0
    salient_feat = list()
    for feature, vals in saliency_dict.items():
        list_item = dbc.ListGroupItem(f&#39;{feature} = {saliency_dict[feature][&#34;data_val&#34;]}&#39;,
                                      color=saliency_dict[feature][&#39;dash_color&#39;])
        salient_feat.append(list_item)
        count += 1
        if count == max_display:
            # Stop displaying more feature values if the specified limit has been reached
            break
    return salient_feat</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="data_utils.visualization.indicator_plot"><code class="name flex">
<span>def <span class="ident">indicator_plot</span></span>(<span>value, min_val=0, max_val=100, type='bullet', higher_is_better=True, background_color='white', output_type='plotly', dash_id='some_indicator', dash_height=None, dash_width=None, show_number=True, show_graph=True, show_delta=False, ref_value=None, font_family='Roboto', font_size=14, font_color='black', prefix='', suffix='', showticklabels=False, animate=False, margin_left=0, margin_right=0, margin_top=0, margin_bottom=0, padding=0)</span>
</code></dt>
<dd>
<div class="desc"><p>Generate an indicator plot, which can help visualize performance. Can
either be of type bullet or gauge.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>value</code></strong> :&ensp;<code>int</code></dt>
<dd>Value which will be plotted on the graph.</dd>
<dt><strong><code>type</code></strong> :&ensp;<code>str</code>, default <code>'bullet'</code></dt>
<dd>Type of indicator plot. Can either be 'bullet' or 'gauge'.</dd>
<dt><strong><code>min_val</code></strong> :&ensp;<code>int</code>, default <code>0</code></dt>
<dd>Minimum value in the range of numbers that the input can assume.</dd>
<dt><strong><code>max_val</code></strong> :&ensp;<code>int</code>, default <code>100</code></dt>
<dd>Maximum value in the range of numbers that the input can assume.</dd>
<dt><strong><code>higher_is_better</code></strong> :&ensp;<code>bool</code>, default <code>True</code></dt>
<dd>If set to True, values closer to the maximum will be represented in green,
while those closer to the minimum will be in red. Vice versa for False.</dd>
<dt><strong><code>background_color</code></strong> :&ensp;<code>str</code>, default <code>'white'</code></dt>
<dd>The plot's background color. Can be set in color name (e.g. 'white'),
hexadecimal code (e.g. '#555') or RGB (e.g. 'rgb(0,0,255)').</dd>
<dt><strong><code>output_type</code></strong> :&ensp;<code>str</code>, default <code>'plotly'</code></dt>
<dd>The format on which the output is presented. Available options are
'dash', <code>plotly</code> and 'figure'.</dd>
<dt><strong><code>dash_id</code></strong> :&ensp;<code>str</code>, default <code>'some_indicator'</code></dt>
<dd>ID to be used in Dash.</dd>
<dt><strong><code>dash_height</code></strong> :&ensp;<code>str</code>, default <code>None</code></dt>
<dd>Height value to be used in the Dash graph.</dd>
<dt><strong><code>dash_width</code></strong> :&ensp;<code>str</code>, default <code>None</code></dt>
<dd>Width value to be used in the Dash graph.</dd>
<dt><strong><code>show_number</code></strong> :&ensp;<code>bool</code>, default <code>True</code></dt>
<dd>If set to True, the number will be shown, whether next to the plot or
on its own.</dd>
<dt><strong><code>show_graph</code></strong> :&ensp;<code>bool</code>, default <code>True</code></dt>
<dd>If set to True, the graph, whether bullet or gauge, will be displayed.</dd>
<dt><strong><code>show_delta</code></strong> :&ensp;<code>bool</code>, default <code>False</code></dt>
<dd>If set to True, the value's variation, based on a reference value, will
be plotted.</dd>
<dt><strong><code>ref_value</code></strong> :&ensp;<code>int</code> or <code>float</code>, default <code>None</code></dt>
<dd>Reference value to use in the delta visualization.</dd>
<dt><strong><code>font_family</code></strong> :&ensp;<code>str</code>, default <code>'Roboto'</code></dt>
<dd>Text font family to be used in the numbers shown next to the graph.</dd>
<dt><strong><code>font_size</code></strong> :&ensp;<code>int</code>, default <code>14</code></dt>
<dd>Text font size to be used in the numbers shown next to the graph.</dd>
<dt><strong><code>font_color</code></strong> :&ensp;<code>str</code>, default <code>'black'</code></dt>
<dd>Text font color to be used in the numbers shown next to the graph. Can
be set in color name (e.g. 'white'), hexadecimal code (e.g. '#555') or
GB (e.g. 'rgb(0,0,255)').</dd>
<dt><strong><code>prefix</code></strong> :&ensp;<code>str</code>, default <code>''</code></dt>
<dd>Text to be appended to the beginning of the number, shown next to the
indicator graph. e.g. '%', '€', 'km', 'g'</dd>
<dt><strong><code>suffix</code></strong> :&ensp;<code>str</code>, default <code>''</code></dt>
<dd>Text to be appended to the end of the number, shown next to the
indicator graph. e.g. '%', '€', 'km', 'g'</dd>
<dt><strong><code>showticklabels</code></strong> :&ensp;<code>bool</code>, default <code>False</code></dt>
<dd>Determines whether or not the tick labels are drawn.</dd>
<dt><strong><code>animate</code></strong> :&ensp;<code>bool</code>, default <code>False</code></dt>
<dd>If true, animate between updates using plotly.js's <code>animate</code> function.</dd>
<dt><strong><code>margin_left</code></strong> :&ensp;<code>int</code>, default <code>0</code></dt>
<dd>Sets the left margin (in px).</dd>
<dt><strong><code>margin_right</code></strong> :&ensp;<code>int</code>, default <code>0</code></dt>
<dd>Sets the right margin (in px).</dd>
<dt><strong><code>margin_top</code></strong> :&ensp;<code>int</code>, default <code>0</code></dt>
<dd>Sets the top margin (in px).</dd>
<dt><strong><code>margin_bottom</code></strong> :&ensp;<code>int</code>, default <code>0</code></dt>
<dd>Sets the bottom margin (in px).</dd>
<dt><strong><code>padding</code></strong> :&ensp;<code>int</code>, default <code>0</code></dt>
<dd>Sets the amount of padding (in px) between the plotting area and
the axis lines.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>If output_type == 'figure':</code></dt>
<dd>&nbsp;</dd>
<dt><strong><code>figure</code></strong> :&ensp;<code>dict</code></dt>
<dd>Figure dictionary which can be used in Plotly.</dd>
<dt><code>Else if output_type == 'plotly':</code></dt>
<dd>&nbsp;</dd>
<dt><strong><code>figure</code></strong> :&ensp;<code>plotly.graph_objs._figure.Figure</code></dt>
<dd>Figure in a plotly figure object, which can be displayed in a notebook.</dd>
<dt><code>Else if output_type == 'dash':</code></dt>
<dd>&nbsp;</dd>
<dt><strong><code>figure</code></strong> :&ensp;<code>dcc.Graph</code></dt>
<dd>Figure in a Dash graph format, ready to be used in a dashboard.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def indicator_plot(value, min_val=0, max_val=100, type=&#39;bullet&#39;, higher_is_better=True,
                   background_color=&#39;white&#39;, output_type=&#39;plotly&#39;, dash_id=&#39;some_indicator&#39;,
                   dash_height=None, dash_width=None, show_number=True, show_graph=True, 
                   show_delta=False, ref_value=None, font_family=&#39;Roboto&#39;, font_size=14, 
                   font_color=&#39;black&#39;, prefix=&#39;&#39;, suffix=&#39;&#39;, showticklabels=False, 
                   animate=False, margin_left=0, margin_right=0, margin_top=0, 
                   margin_bottom=0, padding=0):
    &#39;&#39;&#39;Generate an indicator plot, which can help visualize performance. Can
    either be of type bullet or gauge.

    Parameters
    ----------
    value : int
        Value which will be plotted on the graph.
    type : str, default &#39;bullet&#39;
        Type of indicator plot. Can either be &#39;bullet&#39; or &#39;gauge&#39;.
    min_val : int, default 0
        Minimum value in the range of numbers that the input can assume.
    max_val : int, default 100
        Maximum value in the range of numbers that the input can assume.
    higher_is_better : bool, default True
        If set to True, values closer to the maximum will be represented in green,
        while those closer to the minimum will be in red. Vice versa for False.
    background_color : str, default &#39;white&#39;
        The plot&#39;s background color. Can be set in color name (e.g. &#39;white&#39;),
        hexadecimal code (e.g. &#39;#555&#39;) or RGB (e.g. &#39;rgb(0,0,255)&#39;).
    output_type : str, default &#39;plotly&#39;
        The format on which the output is presented. Available options are
        &#39;dash&#39;, `plotly` and &#39;figure&#39;.
    dash_id : str, default &#39;some_indicator&#39;
        ID to be used in Dash.
    dash_height : str, default None
        Height value to be used in the Dash graph.
    dash_width : str, default None
        Width value to be used in the Dash graph.
    show_number : bool, default True
        If set to True, the number will be shown, whether next to the plot or
        on its own.
    show_graph : bool, default True
        If set to True, the graph, whether bullet or gauge, will be displayed.
    show_delta : bool, default False
        If set to True, the value&#39;s variation, based on a reference value, will
        be plotted.
    ref_value : int or float, default None
        Reference value to use in the delta visualization.
    font_family : str, default &#39;Roboto&#39;
        Text font family to be used in the numbers shown next to the graph.
    font_size : int, default 14
        Text font size to be used in the numbers shown next to the graph.
    font_color : str, default &#39;black&#39;
        Text font color to be used in the numbers shown next to the graph. Can
        be set in color name (e.g. &#39;white&#39;), hexadecimal code (e.g. &#39;#555&#39;) or
        GB (e.g. &#39;rgb(0,0,255)&#39;).
    prefix : str, default &#39;&#39;
        Text to be appended to the beginning of the number, shown next to the
        indicator graph. e.g. &#39;%&#39;, &#39;€&#39;, &#39;km&#39;, &#39;g&#39;
    suffix : str, default &#39;&#39;
        Text to be appended to the end of the number, shown next to the
        indicator graph. e.g. &#39;%&#39;, &#39;€&#39;, &#39;km&#39;, &#39;g&#39;
    showticklabels : bool, default False
        Determines whether or not the tick labels are drawn.
    animate : bool, default False
        If true, animate between updates using plotly.js&#39;s `animate` function.
    margin_left : int, default 0
        Sets the left margin (in px).
    margin_right : int, default 0
        Sets the right margin (in px).
    margin_top : int, default 0
        Sets the top margin (in px).
    margin_bottom : int, default 0
        Sets the bottom margin (in px).
    padding : int, default 0
        Sets the amount of padding (in px) between the plotting area and 
        the axis lines.

    Returns
    -------
    If output_type == &#39;figure&#39;:

    figure : dict
        Figure dictionary which can be used in Plotly.

    Else if output_type == &#39;plotly&#39;:

    figure : plotly.graph_objs._figure.Figure
        Figure in a plotly figure object, which can be displayed in a notebook.

    Else if output_type == &#39;dash&#39;:

    figure : dcc.Graph
        Figure in a Dash graph format, ready to be used in a dashboard.
    &#39;&#39;&#39;
    global perf_colors
    if show_graph:
        # Define the bar color
        if higher_is_better:
            color = perf_colors[int(max((value/max_val)*len(perf_colors)-1, 0))]
        else:
            color = perf_colors[len(perf_colors)-1-int(max((value/max_val)*len(perf_colors)-1, 0))]
    # Define if the value and the delta is shown next to the plot
    if show_number and show_graph and show_delta:
        mode = &#39;number+gauge+delta&#39;
    elif show_number and show_graph and not show_delta:
        mode = &#39;number+gauge&#39;
    elif show_number and not show_graph and show_delta:
        mode = &#39;number+delta&#39;
    elif show_number and not show_graph and not show_delta:
        mode = &#39;number&#39;
    elif not show_number and show_graph and show_delta:
        mode = &#39;gauge+delta&#39;
    elif not show_number and show_graph and not show_delta:
        mode = &#39;gauge&#39;
    if type.lower() == &#39;bullet&#39;:
        shape = &#39;bullet&#39;
    elif type.lower() == &#39;gauge&#39;:
        shape = &#39;angular&#39;
    else:
        raise Exception(f&#39;ERROR: Invalid indicator plot type inserted. Expected &#34;bullet&#34; or &#34;gauge&#34;, received &#34;{type}&#34;.&#39;)
    # Create the figure
    figure=dict(
        data=[dict(
            type=&#39;indicator&#39;,
            mode=mode,
            value=value,
            number=dict(
                font=dict(
                    family=font_family,
                    size=font_size,
                    color=font_color
                ),
                prefix=prefix,
                suffix=suffix
            ),
            delta=dict(reference=ref_value)
        )],
        layout=dict(
            paper_bgcolor=background_color,
            margin=dict(l=margin_left, r=margin_right, t=margin_top, b=margin_bottom, pad=padding),
            font=dict(
                family=font_family,
                size=font_size,
                color=font_color
            )
        )
    )
    if show_graph:
        # Add the graph
        figure[&#39;data&#39;][0][&#39;gauge&#39;] = dict(
            shape=shape,
            bar=dict(
                thickness=1,
                color=color
            ),
            axis=dict(
                range=[min_val, max_val],
                showticklabels=showticklabels
            )
        )
    if output_type == &#39;figure&#39;:
        return figure
    elif output_type == &#39;plotly&#39;:
        return go.Figure(figure)
    elif output_type == &#39;dash&#39;:
        style = dict()
        if dash_height is not None:
            style[&#39;height&#39;] = dash_height
        if dash_width is not None:
            style[&#39;width&#39;] = dash_width
        return dcc.Graph(
            id=dash_id,
            figure=figure,
            style=style,
            config=dict(displayModeBar=False),
            animate=animate
        )
    else:
        raise Exception(f&#39;ERROR: Invalid output type {output_type}. Only `figure`, `plotly` and `dash` are currently supported.&#39;)</code></pre>
</details>
</dd>
<dt id="data_utils.visualization.set_bar_color"><code class="name flex">
<span>def <span class="ident">set_bar_color</span></span>(<span>values, ids, seq_len, threshold=0, neg_color='rgba(30,136,229,1)', pos_color='rgba(255,13,87,1)')</span>
</code></dt>
<dd>
<div class="desc"><p>Determine each bar's color in a bar chart, according to the values being
plotted and the predefined threshold.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>values</code></strong> :&ensp;<code>numpy.Array</code></dt>
<dd>Array containing the values to be plotted.</dd>
<dt><strong><code>ids</code></strong> :&ensp;<code>int</code> or <code>list</code> of <code>ints</code></dt>
<dd>ID or list of ID's that select which time series / sequences to use in
the color selection.</dd>
<dt><strong><code>seq_len</code></strong> :&ensp;<code>int</code> or <code>list</code> of <code>ints</code></dt>
<dd>Single or multiple sequence lengths, which represent the true, unpadded
size of the input sequences.</dd>
<dt><strong><code>threshold</code></strong> :&ensp;<code>int</code> or <code>float</code>, default <code>0</code></dt>
<dd>Value to use as a threshold in the plot's color selection. In other
words, values that exceed this threshold will have one color while the
remaining have a different one, as specified in the parameters.</dd>
<dt><strong><code>pos_color</code></strong> :&ensp;<code>string</code></dt>
<dd>Color to use in the bars corresponding to threshold exceeding values.</dd>
<dt><strong><code>neg_color</code></strong> :&ensp;<code>string</code></dt>
<dd>Color to use in the bars corresponding to values bellow the threshold.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><strong><code>colors</code></strong> :&ensp;<code>list</code> of <code>strings</code></dt>
<dd>Resulting bar colors list.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def set_bar_color(values, ids, seq_len, threshold=0,
                  neg_color=&#39;rgba(30,136,229,1)&#39;, pos_color=&#39;rgba(255,13,87,1)&#39;):
    &#39;&#39;&#39;Determine each bar&#39;s color in a bar chart, according to the values being
    plotted and the predefined threshold.

    Parameters
    ----------
    values : numpy.Array
        Array containing the values to be plotted.
    ids : int or list of ints
        ID or list of ID&#39;s that select which time series / sequences to use in
        the color selection.
    seq_len : int or list of ints
        Single or multiple sequence lengths, which represent the true, unpadded
        size of the input sequences.
    threshold : int or float, default 0
        Value to use as a threshold in the plot&#39;s color selection. In other
        words, values that exceed this threshold will have one color while the
        remaining have a different one, as specified in the parameters.
    pos_color : string
        Color to use in the bars corresponding to threshold exceeding values.
    neg_color : string
        Color to use in the bars corresponding to values bellow the threshold.

    Returns
    -------
    colors : list of strings
        Resulting bar colors list.
    &#39;&#39;&#39;
    if type(ids) is list:
        # Create a list of lists, with the colors for each sequences&#39; instances
        return [[pos_color if val &gt; 0 else neg_color for val in values[id, :seq_len]]
                for id in ids]
    else:
        # Create a single list, with the colors for the sequence&#39;s instances
        return [pos_color if val &gt; 0 else neg_color for val in values[ids, :seq_len]]</code></pre>
</details>
</dd>
<dt id="data_utils.visualization.shap_salient_features"><code class="name flex">
<span>def <span class="ident">shap_salient_features</span></span>(<span>shap_values, features, feature_names, max_display=10, background_color='white', increasing_color='success', decreasing_color='danger', font_family='Roboto', font_size=14, font_color='black', dash_height=None, dash_width=None)</span>
</code></dt>
<dd>
<div class="desc"><p>Create a list of the most salient features, and their corresponding
maximum impact values, based on SHAP values. Only works in Dash, with
bootstrap components.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>shap_values</code></strong> :&ensp;<code>numpy.array</code></dt>
<dd>Two dimensional array of SHAP values.</dd>
<dt><strong><code>features</code></strong> :&ensp;<code>numpy.array</code></dt>
<dd>Two dimensional array of feature values. This provides the values of all
the features, and should be the same shape as the shap_values argument.</dd>
<dt><strong><code>feature_names</code></strong> :&ensp;<code>list</code></dt>
<dd>List of feature names (# features).</dd>
<dt><strong><code>max_display</code></strong> :&ensp;<code>str</code></dt>
<dd>The maximum number of features to show.</dd>
<dt><strong><code>background_color</code></strong> :&ensp;<code>str</code>, default <code>'white'</code></dt>
<dd>The plot's background color. Can be set in color name (e.g. 'white'),
hexadecimal code (e.g. '#555') or RGB (e.g. 'rgb(0,0,255)').</dd>
<dt><strong><code>line_color</code></strong> :&ensp;<code>str</code>, default <code>'gray'</code></dt>
<dd>The waterfall plot's connector color. Can be set in color name
(e.g. 'white'), hexadecimal code (e.g. '#555') or RGB (e.g. 'rgb(0,0,255)').</dd>
<dt><strong><code>increasing_color</code></strong> :&ensp;<code>str</code>, default <code>'red'</code></dt>
<dd>Color of the waterfall bars that indicate an increasing value.</dd>
<dt><strong><code>decreasing_color</code></strong> :&ensp;<code>str</code>, default <code>'blue'</code></dt>
<dd>Color of the waterfall bars that indicate a decreasing value.</dd>
<dt><strong><code>output_type</code></strong> :&ensp;<code>str</code>, default <code>'plotly'</code></dt>
<dd>The format on which the output is presented. Available options are
'dash', <code>plotly</code> and 'figure'.</dd>
<dt><strong><code>dash_height</code></strong> :&ensp;<code>str</code>, default <code>None</code></dt>
<dd>Height value to be used in the Dash graph.</dd>
<dt><strong><code>dash_width</code></strong> :&ensp;<code>str</code>, default <code>None</code></dt>
<dd>Width value to be used in the Dash graph.</dd>
<dt><strong><code>font_family</code></strong> :&ensp;<code>str</code>, default <code>'Roboto'</code></dt>
<dd>Text font family to be used in the numbers shown next to the graph.</dd>
<dt><strong><code>font_size</code></strong> :&ensp;<code>int</code>, default <code>14</code></dt>
<dd>Text font size to be used in the numbers shown next to the graph.</dd>
<dt><strong><code>font_color</code></strong> :&ensp;<code>str</code>, default <code>'black'</code></dt>
<dd>Text font color to be used in the numbers shown next to the graph. Can
be set in color name (e.g. 'white'), hexadecimal code (e.g. '#555') or
GB (e.g. 'rgb(0,0,255)').</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><strong><code>salient_feat</code></strong> :&ensp;<code>list</code> of <code>dbc.ListGroupItem</code></dt>
<dd>List of the most salient features, ready to be used in a dashboard.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def shap_salient_features(shap_values, features, feature_names,
                          max_display=10, background_color=&#39;white&#39;,
                          increasing_color=&#39;success&#39;,
                          decreasing_color=&#39;danger&#39;,
                          font_family=&#39;Roboto&#39;, font_size=14,
                          font_color=&#39;black&#39;,
                          dash_height=None, dash_width=None):
    &#39;&#39;&#39;Create a list of the most salient features, and their corresponding 
    maximum impact values, based on SHAP values. Only works in Dash, with
    bootstrap components.

    Parameters
    ----------
    shap_values : numpy.array
        Two dimensional array of SHAP values.
    features : numpy.array
        Two dimensional array of feature values. This provides the values of all
        the features, and should be the same shape as the shap_values argument.
    feature_names : list
        List of feature names (# features).
    max_display : str
        The maximum number of features to show.
    background_color : str, default &#39;white&#39;
        The plot&#39;s background color. Can be set in color name (e.g. &#39;white&#39;),
        hexadecimal code (e.g. &#39;#555&#39;) or RGB (e.g. &#39;rgb(0,0,255)&#39;).
    line_color : str, default &#39;gray&#39;
        The waterfall plot&#39;s connector color. Can be set in color name
        (e.g. &#39;white&#39;), hexadecimal code (e.g. &#39;#555&#39;) or RGB (e.g. &#39;rgb(0,0,255)&#39;).
    increasing_color : str, default &#39;red&#39;
        Color of the waterfall bars that indicate an increasing value.
    decreasing_color : str, default &#39;blue&#39;
        Color of the waterfall bars that indicate a decreasing value.
    output_type : str, default &#39;plotly&#39;
        The format on which the output is presented. Available options are
        &#39;dash&#39;, `plotly` and &#39;figure&#39;.
    dash_height : str, default None
        Height value to be used in the Dash graph.
    dash_width : str, default None
        Width value to be used in the Dash graph.
    font_family : str, default &#39;Roboto&#39;
        Text font family to be used in the numbers shown next to the graph.
    font_size : int, default 14
        Text font size to be used in the numbers shown next to the graph.
    font_color : str, default &#39;black&#39;
        Text font color to be used in the numbers shown next to the graph. Can
        be set in color name (e.g. &#39;white&#39;), hexadecimal code (e.g. &#39;#555&#39;) or
        GB (e.g. &#39;rgb(0,0,255)&#39;).

    Returns
    -------
    salient_feat : list of dbc.ListGroupItem
        List of the most salient features, ready to be used in a dashboard.
    &#39;&#39;&#39;
    # [TODO] Add support for a single sample (1D) or multiple sequences (3D)
    if len(shap_values.shape) != 2:
        raise Exception(f&#39;ERROR: Expected a sequence of data, i.e. a two dimensional array. Received a {shap_values.shape}D input.&#39;)
    # Create a dictionary to match each feature to its biggest absolute value,
    # the corresponding feature value (found by the data point&#39;s index)
    # and color (according to the SHAP value sign)
    saliency_dict = dict()
    # Indices of the maximum absolute SHAP value for each feature
    abs_shap = abs(shap_values)
    max_abs_shap_val_idx = np.argmax(abs_shap, axis=0)
    for feat_num in range(shap_values.shape[-1]):
        # Get the feature name, maximum absolute SHAP value and data value
        feature = feature_names[feat_num]
        saliency_dict[feature] = dict()
        saliency_dict[feature][&#39;max_abs_shap_val&#39;] = shap_values[max_abs_shap_val_idx[feat_num], feat_num]
        saliency_dict[feature][&#39;data_val&#39;] = features[max_abs_shap_val_idx[feat_num], feat_num]
        # Set the Dash list item color
        if saliency_dict[feature][&#39;max_abs_shap_val&#39;] &gt; 0:
            saliency_dict[feature][&#39;dash_color&#39;] = increasing_color 
        else:
            saliency_dict[feature][&#39;dash_color&#39;] = decreasing_color
    # Sort the features by their maximum SHAP value, in a descending order
    saliency_dict = sorted(saliency_dict.items(), key=lambda item: abs(item[1][&#39;max_abs_shap_val&#39;]))
    saliency_dict.reverse()
    saliency_dict = dict(saliency_dict)
    # Filter to the top `max_display` features
    if max_display is None or max_display &gt; len(saliency_dict):
        max_display = len(saliency_dict)
    # Create the Dash list
    count = 0
    salient_feat = list()
    for feature, vals in saliency_dict.items():
        list_item = dbc.ListGroupItem(f&#39;{feature} = {saliency_dict[feature][&#34;data_val&#34;]}&#39;,
                                      color=saliency_dict[feature][&#39;dash_color&#39;])
        salient_feat.append(list_item)
        count += 1
        if count == max_display:
            # Stop displaying more feature values if the specified limit has been reached
            break
    return salient_feat</code></pre>
</details>
</dd>
<dt id="data_utils.visualization.shap_summary_plot"><code class="name flex">
<span>def <span class="ident">shap_summary_plot</span></span>(<span>shap_values, feature_names, max_display=10, background_color='white', marker_color='blue', output_type='plotly', dash_id='some_shap_summary_plot', dash_height=None, dash_width=None, font_family='Roboto', font_size=14, font_color='black', xaxis_title='mean(|SHAP value|) (average impact on model output magnitude)', margin_left=0, margin_right=0, margin_top=0, margin_bottom=0, padding=0)</span>
</code></dt>
<dd>
<div class="desc"><p>Plot the overall feature importance, based on SHAP values, through an
horizontal bar plot.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>shap_values</code></strong> :&ensp;<code>numpy.ndarray</code> or <code>list</code></dt>
<dd>Array or list containing all the SHAP values which we want to plot.</dd>
<dt><strong><code>feature_names</code></strong> :&ensp;<code>list</code></dt>
<dd>List with the names of the features that the SHAP values refer to.</dd>
<dt><strong><code>max_display</code></strong> :&ensp;<code>int</code></dt>
<dd>The maximum number of features to plot.</dd>
<dt><strong><code>background_color</code></strong> :&ensp;<code>str</code>, default <code>'white'</code></dt>
<dd>The plot's background color. Can be set in color name (e.g. 'white'),
hexadecimal code (e.g. '#555') or RGB (e.g. 'rgb(0,0,255)').</dd>
<dt><strong><code>marker_color</code></strong> :&ensp;<code>str</code>, default <code>'blue'</code></dt>
<dd>The color of the bars in the plot. Can be set in color name (e.g. 'white'),
hexadecimal code (e.g. '#555') or RGB (e.g. 'rgb(0,0,255)').</dd>
<dt><strong><code>output_type</code></strong> :&ensp;<code>str</code>, default <code>'plotly'</code></dt>
<dd>The format on which the output is presented. Available options are
'dash', <code>plotly</code> and 'figure'.</dd>
<dt><strong><code>dash_id</code></strong> :&ensp;<code>str</code>, default <code>'some_shap_summary_plot'</code></dt>
<dd>ID to be used in Dash.</dd>
<dt><strong><code>dash_height</code></strong> :&ensp;<code>str</code>, default <code>None</code></dt>
<dd>Height value to be used in the Dash graph.</dd>
<dt><strong><code>dash_width</code></strong> :&ensp;<code>str</code>, default <code>None</code></dt>
<dd>Width value to be used in the Dash graph.</dd>
<dt><strong><code>font_family</code></strong> :&ensp;<code>str</code>, default <code>'Roboto'</code></dt>
<dd>Text font family to be used in the numbers shown next to the graph.</dd>
<dt><strong><code>font_size</code></strong> :&ensp;<code>int</code>, default <code>14</code></dt>
<dd>Text font size to be used in the numbers shown next to the graph.</dd>
<dt><strong><code>font_color</code></strong> :&ensp;<code>str</code>, default <code>'black'</code></dt>
<dd>Text font color to be used in the numbers shown next to the graph. Can
be set in color name (e.g. 'white'), hexadecimal code (e.g. '#555') or
GB (e.g. 'rgb(0,0,255)').</dd>
<dt><strong><code>xaxis_title</code></strong> :&ensp;<code>str</code>, default <code>'mean(|SHAP value|) (average impact on model output magnitude)'</code></dt>
<dd>Phrase that appears bellow the X axis.</dd>
<dt><strong><code>margin_left</code></strong> :&ensp;<code>int</code>, default <code>0</code></dt>
<dd>Sets the left margin (in px).</dd>
<dt><strong><code>margin_right</code></strong> :&ensp;<code>int</code>, default <code>0</code></dt>
<dd>Sets the right margin (in px).</dd>
<dt><strong><code>margin_top</code></strong> :&ensp;<code>int</code>, default <code>0</code></dt>
<dd>Sets the top margin (in px).</dd>
<dt><strong><code>margin_bottom</code></strong> :&ensp;<code>int</code>, default <code>0</code></dt>
<dd>Sets the bottom margin (in px).</dd>
<dt><strong><code>padding</code></strong> :&ensp;<code>int</code>, default <code>0</code></dt>
<dd>Sets the amount of padding (in px) between the plotting area and
the axis lines.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>If output_type == 'figure':</code></dt>
<dd>&nbsp;</dd>
<dt><strong><code>figure</code></strong> :&ensp;<code>dict</code></dt>
<dd>Figure dictionary which can be used in Plotly.</dd>
<dt><code>Else if output_type == 'plotly':</code></dt>
<dd>&nbsp;</dd>
<dt><strong><code>figure</code></strong> :&ensp;<code>plotly.graph_objs._figure.Figure</code></dt>
<dd>Figure in a plotly figure object, which can be displayed in a notebook.</dd>
<dt><code>Else if output_type == 'dash':</code></dt>
<dd>&nbsp;</dd>
<dt><strong><code>figure</code></strong> :&ensp;<code>dcc.Graph</code></dt>
<dd>Figure in a Dash graph format, ready to be used in a dashboard.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def shap_summary_plot(shap_values, feature_names, max_display=10,
                      background_color=&#39;white&#39;, marker_color=&#39;blue&#39;,
                      output_type=&#39;plotly&#39;, dash_id=&#39;some_shap_summary_plot&#39;,
                      dash_height=None, dash_width=None, font_family=&#39;Roboto&#39;,
                      font_size=14, font_color=&#39;black&#39;,
                      xaxis_title=&#39;mean(|SHAP value|) (average impact on model output magnitude)&#39;,
                      margin_left=0, margin_right=0, margin_top=0, margin_bottom=0, padding=0):
    &#39;&#39;&#39;Plot the overall feature importance, based on SHAP values, through an
    horizontal bar plot.

    Parameters
    ----------
    shap_values : numpy.ndarray or list
        Array or list containing all the SHAP values which we want to plot.
    feature_names : list
        List with the names of the features that the SHAP values refer to.
    max_display : int
        The maximum number of features to plot.
    background_color : str, default &#39;white&#39;
        The plot&#39;s background color. Can be set in color name (e.g. &#39;white&#39;),
        hexadecimal code (e.g. &#39;#555&#39;) or RGB (e.g. &#39;rgb(0,0,255)&#39;).
    marker_color : str, default &#39;blue&#39;
        The color of the bars in the plot. Can be set in color name (e.g. &#39;white&#39;),
        hexadecimal code (e.g. &#39;#555&#39;) or RGB (e.g. &#39;rgb(0,0,255)&#39;).
    output_type : str, default &#39;plotly&#39;
        The format on which the output is presented. Available options are
        &#39;dash&#39;, `plotly` and &#39;figure&#39;.
    dash_id : str, default &#39;some_shap_summary_plot&#39;
        ID to be used in Dash.
    dash_height : str, default None
        Height value to be used in the Dash graph.
    dash_width : str, default None
        Width value to be used in the Dash graph.
    font_family : str, default &#39;Roboto&#39;
        Text font family to be used in the numbers shown next to the graph.
    font_size : int, default 14
        Text font size to be used in the numbers shown next to the graph.
    font_color : str, default &#39;black&#39;
        Text font color to be used in the numbers shown next to the graph. Can
        be set in color name (e.g. &#39;white&#39;), hexadecimal code (e.g. &#39;#555&#39;) or
        GB (e.g. &#39;rgb(0,0,255)&#39;).
    xaxis_title : str, default &#39;mean(|SHAP value|) (average impact on model output magnitude)&#39;
        Phrase that appears bellow the X axis.
    margin_left : int, default 0
        Sets the left margin (in px).
    margin_right : int, default 0
        Sets the right margin (in px).
    margin_top : int, default 0
        Sets the top margin (in px).
    margin_bottom : int, default 0
        Sets the bottom margin (in px).
    padding : int, default 0
        Sets the amount of padding (in px) between the plotting area and 
        the axis lines.

    Returns
    -------
    If output_type == &#39;figure&#39;:

    figure : dict
        Figure dictionary which can be used in Plotly.

    Else if output_type == &#39;plotly&#39;:

    figure : plotly.graph_objs._figure.Figure
        Figure in a plotly figure object, which can be displayed in a notebook.

    Else if output_type == &#39;dash&#39;:

    figure : dcc.Graph
        Figure in a Dash graph format, ready to be used in a dashboard.
    &#39;&#39;&#39;
    # Calculate the mean absolute value of each feature&#39;s SHAP values
    mean_abs_shap = np.mean(np.abs(shap_values).reshape(-1, shap_values.shape[-1]), axis=0)
    # Sort the SHAP values and the feature names
    sorted_idx = np.argsort(mean_abs_shap)
    if max_display is not None:
        # Only show the `max_display` most impactful features
        sorted_idx = sorted_idx[-max_display:]
    sorted_mean_abs_shap = mean_abs_shap[sorted_idx]
    sorted_feature_names = [feature_names[idx] for idx in sorted_idx]
    # Create the figure
    figure=dict(
        data=[dict(
            type=&#39;bar&#39;,
            x=sorted_mean_abs_shap,
            y=sorted_feature_names,
            orientation=&#39;h&#39;,
            marker=dict(color=marker_color)
        )],
        layout=dict(
            paper_bgcolor=background_color,
            plot_bgcolor=background_color,
            margin=dict(l=margin_left, r=margin_right, t=margin_top, b=margin_bottom, pad=padding),
            xaxis_title=xaxis_title,
            xaxis=dict(showgrid=False),
            font=dict(
                family=font_family,
                size=font_size,
                color=font_color
            )
        )
    )
    if output_type == &#39;figure&#39;:
        return figure
    elif output_type == &#39;plotly&#39;:
        return go.Figure(figure)
    elif output_type == &#39;dash&#39;:
        style = dict()
        if dash_height is not None:
            style[&#39;height&#39;] = dash_height
        if dash_width is not None:
            style[&#39;width&#39;] = dash_width
        return dcc.Graph(
            id=dash_id,
            figure=figure,
            style=style
        )
    else:
        raise Exception(f&#39;ERROR: Invalid output type {output_type}. Only `figure`, `plotly` and `dash` are currently supported.&#39;)</code></pre>
</details>
</dd>
<dt id="data_utils.visualization.shap_waterfall_plot"><code class="name flex">
<span>def <span class="ident">shap_waterfall_plot</span></span>(<span>expected_value, shap_values, features, feature_names, max_display=10, background_color='white', line_color='gray', increasing_color='red', decreasing_color='blue', output_type='plotly', dash_id='some_shap_summary_plot', dash_height=None, dash_width=None, expected_value_ind_height=0, output_ind_height=10, font_family='Roboto', font_size=14, font_color='black', margin_left=0, margin_right=0, margin_top=0, margin_bottom=0, padding=0)</span>
</code></dt>
<dd>
<div class="desc"><p>Do a waterfall plot on a single sample, based on SHAP values, showing
each feature's contribution to the corresponding output.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>expected_value</code></strong> :&ensp;<code>float</code></dt>
<dd>This is the reference value that the feature contributions start from.
For SHAP values it should be the value of explainer.expected_value.</dd>
<dt><strong><code>shap_values</code></strong> :&ensp;<code>numpy.array</code></dt>
<dd>One dimensional array of SHAP values.</dd>
<dt><strong><code>features</code></strong> :&ensp;<code>numpy.array</code></dt>
<dd>One dimensional array of feature values. This provides the values of all
the features, and should be the same shape as the shap_values argument.</dd>
<dt><strong><code>feature_names</code></strong> :&ensp;<code>list</code></dt>
<dd>List of feature names (# features).</dd>
<dt><strong><code>max_display</code></strong> :&ensp;<code>str</code></dt>
<dd>The maximum number of features to plot.</dd>
<dt><strong><code>background_color</code></strong> :&ensp;<code>str</code>, default <code>'white'</code></dt>
<dd>The plot's background color. Can be set in color name (e.g. 'white'),
hexadecimal code (e.g. '#555') or RGB (e.g. 'rgb(0,0,255)').</dd>
<dt><strong><code>line_color</code></strong> :&ensp;<code>str</code>, default <code>'gray'</code></dt>
<dd>The waterfall plot's connector color. Can be set in color name
(e.g. 'white'), hexadecimal code (e.g. '#555') or RGB (e.g. 'rgb(0,0,255)').</dd>
<dt><strong><code>increasing_color</code></strong> :&ensp;<code>str</code>, default <code>'red'</code></dt>
<dd>Color of the waterfall bars that indicate an increasing value.</dd>
<dt><strong><code>decreasing_color</code></strong> :&ensp;<code>str</code>, default <code>'blue'</code></dt>
<dd>Color of the waterfall bars that indicate a decreasing value.</dd>
<dt><strong><code>output_type</code></strong> :&ensp;<code>str</code>, default <code>'plotly'</code></dt>
<dd>The format on which the output is presented. Available options are
'dash', <code>plotly</code> and 'figure'.</dd>
<dt><strong><code>dash_id</code></strong> :&ensp;<code>str</code>, default <code>'some_shap_summary_plot'</code></dt>
<dd>ID to be used in Dash.</dd>
<dt><strong><code>dash_height</code></strong> :&ensp;<code>str</code>, default <code>None</code></dt>
<dd>Height value to be used in the Dash graph.</dd>
<dt><strong><code>dash_width</code></strong> :&ensp;<code>str</code>, default <code>None</code></dt>
<dd>Width value to be used in the Dash graph.</dd>
<dt><strong><code>expected_value_ind_height</code></strong> :&ensp;<code>int</code>, default <code>0</code></dt>
<dd>Height of the expected value indicator.</dd>
<dt><strong><code>output_ind_height</code></strong> :&ensp;<code>int</code>, default <code>10</code></dt>
<dd>Height of the output indicator.</dd>
<dt><strong><code>font_family</code></strong> :&ensp;<code>str</code>, default <code>'Roboto'</code></dt>
<dd>Text font family to be used in the numbers shown next to the graph.</dd>
<dt><strong><code>font_size</code></strong> :&ensp;<code>int</code>, default <code>14</code></dt>
<dd>Text font size to be used in the numbers shown next to the graph.</dd>
<dt><strong><code>font_color</code></strong> :&ensp;<code>str</code>, default <code>'black'</code></dt>
<dd>Text font color to be used in the numbers shown next to the graph. Can
be set in color name (e.g. 'white'), hexadecimal code (e.g. '#555') or
GB (e.g. 'rgb(0,0,255)').</dd>
<dt><strong><code>margin_left</code></strong> :&ensp;<code>int</code>, default <code>0</code></dt>
<dd>Sets the left margin (in px).</dd>
<dt><strong><code>margin_right</code></strong> :&ensp;<code>int</code>, default <code>0</code></dt>
<dd>Sets the right margin (in px).</dd>
<dt><strong><code>margin_top</code></strong> :&ensp;<code>int</code>, default <code>0</code></dt>
<dd>Sets the top margin (in px).</dd>
<dt><strong><code>margin_bottom</code></strong> :&ensp;<code>int</code>, default <code>0</code></dt>
<dd>Sets the bottom margin (in px).</dd>
<dt><strong><code>padding</code></strong> :&ensp;<code>int</code>, default <code>0</code></dt>
<dd>Sets the amount of padding (in px) between the plotting area and
the axis lines.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>If output_type == 'figure':</code></dt>
<dd>&nbsp;</dd>
<dt><strong><code>figure</code></strong> :&ensp;<code>dict</code></dt>
<dd>Figure dictionary which can be used in Plotly.</dd>
<dt><code>Else if output_type == 'plotly':</code></dt>
<dd>&nbsp;</dd>
<dt><strong><code>figure</code></strong> :&ensp;<code>plotly.graph_objs._figure.Figure</code></dt>
<dd>Figure in a plotly figure object, which can be displayed in a notebook.</dd>
<dt><code>Else if output_type == 'dash':</code></dt>
<dd>&nbsp;</dd>
<dt><strong><code>figure</code></strong> :&ensp;<code>dcc.Graph</code></dt>
<dd>Figure in a Dash graph format, ready to be used in a dashboard.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def shap_waterfall_plot(expected_value, shap_values, features, feature_names,
                        max_display=10, background_color=&#39;white&#39;,
                        line_color=&#39;gray&#39;, increasing_color=&#39;red&#39;,
                        decreasing_color=&#39;blue&#39;, output_type=&#39;plotly&#39;,
                        dash_id=&#39;some_shap_summary_plot&#39;, dash_height=None,
                        dash_width=None, expected_value_ind_height=0,
                        output_ind_height=10, font_family=&#39;Roboto&#39;, 
                        font_size=14, font_color=&#39;black&#39;,
                        margin_left=0, margin_right=0, margin_top=0, 
                        margin_bottom=0, padding=0):
    &#39;&#39;&#39;Do a waterfall plot on a single sample, based on SHAP values, showing
    each feature&#39;s contribution to the corresponding output.

    Parameters
    ----------
    expected_value : float
        This is the reference value that the feature contributions start from.
        For SHAP values it should be the value of explainer.expected_value.
    shap_values : numpy.array
        One dimensional array of SHAP values.
    features : numpy.array
        One dimensional array of feature values. This provides the values of all
        the features, and should be the same shape as the shap_values argument.
    feature_names : list
        List of feature names (# features).
    max_display : str
        The maximum number of features to plot.
    background_color : str, default &#39;white&#39;
        The plot&#39;s background color. Can be set in color name (e.g. &#39;white&#39;),
        hexadecimal code (e.g. &#39;#555&#39;) or RGB (e.g. &#39;rgb(0,0,255)&#39;).
    line_color : str, default &#39;gray&#39;
        The waterfall plot&#39;s connector color. Can be set in color name
        (e.g. &#39;white&#39;), hexadecimal code (e.g. &#39;#555&#39;) or RGB (e.g. &#39;rgb(0,0,255)&#39;).
    increasing_color : str, default &#39;red&#39;
        Color of the waterfall bars that indicate an increasing value.
    decreasing_color : str, default &#39;blue&#39;
        Color of the waterfall bars that indicate a decreasing value.
    output_type : str, default &#39;plotly&#39;
        The format on which the output is presented. Available options are
        &#39;dash&#39;, `plotly` and &#39;figure&#39;.
    dash_id : str, default &#39;some_shap_summary_plot&#39;
        ID to be used in Dash.
    dash_height : str, default None
        Height value to be used in the Dash graph.
    dash_width : str, default None
        Width value to be used in the Dash graph.
    expected_value_ind_height : int, default 0
        Height of the expected value indicator.
    output_ind_height : int, default 10
        Height of the output indicator.
    font_family : str, default &#39;Roboto&#39;
        Text font family to be used in the numbers shown next to the graph.
    font_size : int, default 14
        Text font size to be used in the numbers shown next to the graph.
    font_color : str, default &#39;black&#39;
        Text font color to be used in the numbers shown next to the graph. Can
        be set in color name (e.g. &#39;white&#39;), hexadecimal code (e.g. &#39;#555&#39;) or
        GB (e.g. &#39;rgb(0,0,255)&#39;).
    margin_left : int, default 0
        Sets the left margin (in px).
    margin_right : int, default 0
        Sets the right margin (in px).
    margin_top : int, default 0
        Sets the top margin (in px).
    margin_bottom : int, default 0
        Sets the bottom margin (in px).
    padding : int, default 0
        Sets the amount of padding (in px) between the plotting area and 
        the axis lines.

    Returns
    -------
    If output_type == &#39;figure&#39;:

    figure : dict
        Figure dictionary which can be used in Plotly.

    Else if output_type == &#39;plotly&#39;:

    figure : plotly.graph_objs._figure.Figure
        Figure in a plotly figure object, which can be displayed in a notebook.

    Else if output_type == &#39;dash&#39;:

    figure : dcc.Graph
        Figure in a Dash graph format, ready to be used in a dashboard.
    &#39;&#39;&#39;
    if len(shap_values.shape) &gt; 1:
        raise Exception(f&#39;ERROR: Received multiple samples, with input shape {shap_values.shape}. The waterfall plot only handles individual samples, i.e. one-dimensional inputs.&#39;)
    # Get the model&#39;s output on the current sample
    model_output = shap_values.sum() + expected_value
    # Sort the SHAP values and the feature names
    sorted_idx = np.argsort(np.abs(shap_values))
    sorted_shap_values = shap_values[sorted_idx]
    sorted_features = features[sorted_idx]
    sorted_feature_names = [feature_names[idx] for idx in sorted_idx]
    if max_display is None:
        max_display = len(sorted_feature_names)
    if max_display &lt; len(sorted_feature_names):
        # Isolate the data regarding the less relevant features that will be aggregated
        other_features_shap_values = sorted_shap_values[:-(max_display-1)]
        other_features_names = sorted_feature_names[:-(max_display-1)]
        n_other_features = len(other_features_names)
        # Get the sum of the less relevant features&#39; SHAP values
        other_features_shap_values = other_features_shap_values.sum()
        # Remove the detailed info of the less relevant features
        sorted_shap_values = sorted_shap_values[-(max_display-1):]
        sorted_feature_names = sorted_feature_names[-(max_display-1):]
        sorted_features = sorted_features[-(max_display-1):]
        # Add the less relevant features aggregate data into the plot
        hovertext = [f&#39;{feature}={val}&#39; if du.utils.is_integer(val) else f&#39;{feature}={val:.2e}&#39;
                     for (feature, val) in zip(sorted_feature_names, sorted_features)]
        hovertext = [&#39;Multiple features&#39;] + hovertext
        sorted_shap_values = np.insert(sorted_shap_values, 0, other_features_shap_values)
        sorted_feature_names = [f&#39;{n_other_features} other features&#39;] + sorted_feature_names
    else:
        hovertext = [f&#39;{feature}={val}&#39; if du.utils.is_integer(val) else f&#39;{feature}={val:.2e}&#39;
                     for (feature, val) in zip(sorted_feature_names, sorted_features)]
    # Create the figure
    figure=dict(
        data=[dict(
            type=&#39;waterfall&#39;,
            x=sorted_shap_values,
            y=sorted_feature_names,
            base=expected_value,
            hovertext=hovertext,
            orientation=&#39;h&#39;,
            connector=dict(line=dict(color=line_color)),
            increasing=dict(marker=dict(color=increasing_color)),
            decreasing=dict(marker=dict(color=decreasing_color))
        )],
        layout=dict(
            paper_bgcolor=background_color,
            plot_bgcolor=background_color,
            margin=dict(l=margin_left, r=margin_right, t=margin_top, b=margin_bottom, pad=padding),
            xaxis_title=&#39;Output value&#39;,
            xaxis=dict(showgrid=False, autorange=True, rangemode=&#39;normal&#39;),
            font=dict(
                family=font_family,
                size=font_size,
                color=font_color
            ),
            annotations=[
                # Expected value indicator
                dict(
                    # x-reference is assigned to the x-values
                    xref=&#39;x&#39;,
                    # y-reference is assigned to the plot paper [0,1]
                    yref=&#39;paper&#39;,
                    x=expected_value,
                    y=0,
                    text=f&#39;E[f(X)]={expected_value:.2e}&#39;,
                    showarrow=True,
                    arrowhead=0,
                    ax=0,
                    ay=expected_value_ind_height
                ),
                # Output value indicator
                dict(
                    # x-reference is assigned to the x-values
                    xref=&#39;x&#39;,
                    # y-reference is assigned to the plot paper [0,1]
                    yref=&#39;paper&#39;,
                    x=model_output,
                    y=1,
                    text=f&#39;f(x)={model_output:.2e}&#39;,
                    showarrow=True,
                    arrowhead=0,
                    ax=0,
                    ay=output_ind_height
                )
            ],
            shapes=[
                # Expected value line
                dict(
                    type=&#39;line&#39;,
                    # x-reference is assigned to the x-values
                    xref=&#39;x&#39;,
                    # y-reference is assigned to the plot paper [0,1]
                    yref=&#39;paper&#39;,
                    x0=expected_value,
                    y0=0,
                    x1=expected_value,
                    y1=1,
                    fillcolor=line_color,
                    line=dict(
                        color=line_color,
                        width=1
                    ),
                    opacity=0.5,
                    # NOTE: I can&#39;t put this line bellow the traces, otherwise
                    # the waterfall conectors will create a blank line in the middle of it
#                     layer=&#39;below&#39;
                ),
                # Output value line
                dict(
                    type=&#39;line&#39;,
                    # x-reference is assigned to the x-values
                    xref=&#39;x&#39;,
                    # y-reference is assigned to the plot paper [0,1]
                    yref=&#39;paper&#39;,
                    x0=model_output,
                    y0=0,
                    x1=model_output,
                    y1=1,
                    fillcolor=line_color,
                    line=dict(
                        color=line_color,
                        width=1
                    ),
                    opacity=0.5,
                    layer=&#39;below&#39;
                )
            ]
        )
    )
    if output_type == &#39;figure&#39;:
        return figure
    elif output_type == &#39;plotly&#39;:
        return go.Figure(figure)
    elif output_type == &#39;dash&#39;:
        style = dict()
        if dash_height is not None:
            style[&#39;height&#39;] = dash_height
        if dash_width is not None:
            style[&#39;width&#39;] = dash_width
        return dcc.Graph(
            id=dash_id,
            figure=figure,
            style=style
        )
    else:
        raise Exception(f&#39;ERROR: Invalid output type {output_type}. Only `figure`, `plotly` and `dash` are currently supported.&#39;)</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="data_utils" href="index.html">data_utils</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="data_utils.visualization.indicator_plot" href="#data_utils.visualization.indicator_plot">indicator_plot</a></code></li>
<li><code><a title="data_utils.visualization.set_bar_color" href="#data_utils.visualization.set_bar_color">set_bar_color</a></code></li>
<li><code><a title="data_utils.visualization.shap_salient_features" href="#data_utils.visualization.shap_salient_features">shap_salient_features</a></code></li>
<li><code><a title="data_utils.visualization.shap_summary_plot" href="#data_utils.visualization.shap_summary_plot">shap_summary_plot</a></code></li>
<li><code><a title="data_utils.visualization.shap_waterfall_plot" href="#data_utils.visualization.shap_waterfall_plot">shap_waterfall_plot</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.9.1</a>.</p>
</footer>
</body>
</html>